sudo: enabled
services: docker
dist: trusty
language: python
os:
  - linux
python:
  - "3.6"

before_install:
  - echo $GOOGLE_PACKER_CREDENTIALS > $TRAVIS_BUILD_DIR/demo-infra.json
  - export GOOGLE_APPLICATION_CREDENTIALS=$TRAVIS_BUILD_DIR/demo-infra.json
  - sudo apt-get update && sudo apt-get install -y curl
  - mkdir bin && cd bin
  - curl -L -o packer_1.4.3_linux_amd64.zip https://releases.hashicorp.com/packer/1.4.3/packer_1.4.3_linux_amd64.zip
  - sudo unzip packer_1.4.3_linux_amd64.zip
  - sudo mv packer /usr/local/bin/
  - rm packer_1.4.3_linux_amd64.zip
  - curl -L -o terraform_0.12.8_linux_amd64.zip https://releases.hashicorp.com/terraform/0.12.8/terraform_0.12.8_linux_amd64.zip
  - sudo unzip terraform_0.12.8_linux_amd64.zip
  - sudo mv terraform /usr/local/bin
  - rm -fv terraform_0.12.8_linux_amd64.zip
  - cd ..

install:
  - sudo apt-get update
  - sudo apt-get install -y python-pip libssl-dev
  - pip install --upgrade pip setuptools wheel PyYAML six urllib3 chardet requests colorama
  - pip install ansible
  - pip install molecule testinfra
  - pip install apache-libcloud
  - pip install --upgrade apache-libcloud>=0.17.0

jobs:
  include:
    - stage: "API Tests"
      name: "PyTest Tests"
      script:
        - make tests-app
    - stage: "Build Container Image on Staging"
      name: "Build and Push Docker Image"
      script:
        - cd src
        - export HASH=`date +%d%m%Y%H%M%S`
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker build -t perylemke/apery:$HASH .
        - docker tag perylemke/apery:$HASH perylemke/apery
        - docker push perylemke/apery:$HASH
        - docker push perylemke/apery
      if: branch = master
    - stage: "Infra Tests"
      name: "Molecule Infra Tests"
      script:
        - mkdir -p $HOME/.ssh
        - gcloud version || true
        - if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then rm -rf $HOME/google-cloud-sdk; export CLOUDSDK_CORE_DISABLE_PROMPTS=1; curl https://sdk.cloud.google.com | bash > /dev/null; fi
        - source $HOME/google-cloud-sdk/path.bash.inc
        - gcloud auth activate-service-account $GCE_SERVICE_ACCOUNT_EMAIL --key-file $GOOGLE_APPLICATION_CREDENTIALS
        - gsutil cp gs://dogma-apery/google_compute_engine $HOME/.ssh/google_compute_engine
        - chmod 600 $HOME/.ssh/google_compute_engine
        - gsutil cp gs://dogma-apery/google_compute_engine.pub $HOME/.ssh/google_compute_engine.pub
        - chmod 644 $HOME/.ssh/google_compute_engine.pub
        - make tests-infra
      if: branch = fix_molecule
    - stage: "Build VM image"
      name: "Build VM image with Packer"
      script:
        - make build
      if: branch = master
    - stage: "Deploy"
      name: "Deploy with Terraform"
      script:
        - make init
        - make deploy-$DEPLOY_ENV
      if: branch = master
